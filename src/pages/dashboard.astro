---
import Layout from '../layouts/Layout.astro';
---

<Layout title="coens-labpicker-25 - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰">
  <div class="container">
    <header>
      <h1>ğŸ”¬ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <div class="user-info">
        <span id="user-email"></span>
        <button id="logout-btn" class="btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </header>

    <div id="loading" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>

    <div id="content" style="display: none;">
      <!-- ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
      <section class="card">
        <h2>ğŸ“ å¿—æœ›æƒ…å ±ã®ç™»éŒ²</h2>
        <form id="preference-form">
          <div class="form-group">
            <label for="gpa">GPA <span class="required">*</span></label>
            <input 
              type="number" 
              id="gpa" 
              step="0.01" 
              min="0" 
              max="4.30" 
              placeholder="ä¾‹: 3.45"
              required
            />
            <small>0.00 ã€œ 4.30 ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„</small>
          </div>

          <div class="form-group">
            <label for="lab-select">ç¬¬1å¿—æœ›ç ”ç©¶å®¤ <span class="required">*</span></label>
            <select id="lab-select" required>
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>

          <button type="submit" class="btn-primary">ç™»éŒ²ãƒ»æ›´æ–°</button>
        </form>

        <div id="current-preference" class="current-info" style="display: none;">
          <h3>ç¾åœ¨ã®ç™»éŒ²æƒ…å ±</h3>
          <p><strong>GPA:</strong> <span id="current-gpa"></span></p>
          <p><strong>ç¬¬1å¿—æœ›:</strong> <span id="current-lab"></span></p>
        </div>
      </section>

      <!-- ç ”ç©¶å®¤ä¸€è¦§ -->
      <section class="card">
        <h2>ğŸ“Š ç ”ç©¶å®¤ä¸€è¦§</h2>
        
        <div class="filter-group">
          <label for="major-filter">ä¸»å°‚æ”»:</label>
          <select id="major-filter">
            <option value="">ã™ã¹ã¦è¡¨ç¤º</option>
            <option value="å¿œç”¨ç‰©ç†ä¸»å°‚æ”»">å¿œç”¨ç‰©ç†ä¸»å°‚æ”»</option>
            <option value="é›»å­ãƒ»é‡å­å·¥å­¦ä¸»å°‚æ”»">é›»å­ãƒ»é‡å­å·¥å­¦ä¸»å°‚æ”»</option>
            <option value="ç‰©æ€§å·¥å­¦ä¸»å°‚æ”»">ç‰©æ€§å·¥å­¦ä¸»å°‚æ”»</option>
            <option value="ç‰©è³ªãƒ»åˆ†å­å·¥å­¦ä¸»å°‚æ”»">ç‰©è³ªãƒ»åˆ†å­å·¥å­¦ä¸»å°‚æ”»</option>
          </select>
        </div>

        <div id="labs-list" class="labs-list"></div>
      </section>
    </div>
  </div>

  <script>
    import { supabase, type Lab, type Student, type LabApplicant } from '../lib/supabase';

    let currentUser: any = null;
    let allLabs: Lab[] = [];
    let currentStudent: Student | null = null;

    // åˆæœŸåŒ–
    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session) {
        window.location.href = '/';
        return;
      }

      currentUser = session.user;

      // ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
      if (!currentUser.email?.endsWith('@u.tsukuba.ac.jp')) {
        alert('ç­‘æ³¢å¤§å­¦ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™');
        await supabase.auth.signOut();
        window.location.href = '/';
        return;
      }

      document.getElementById('user-email')!.textContent = currentUser.email;

      await Promise.all([
        loadLabs(),
        loadStudentData()
      ]);

      document.getElementById('loading')!.style.display = 'none';
      document.getElementById('content')!.style.display = 'block';
    }

    // ç ”ç©¶å®¤ãƒ‡ãƒ¼ã‚¿å–å¾—
    async function loadLabs() {
      const { data, error } = await supabase
        .from('labs')
        .select('*')
        .order('major')
        .order('name');

      if (error) {
        console.error('ç ”ç©¶å®¤ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return;
      }

      allLabs = data || [];
      populateLabSelect();
      displayLabs();
    }

    // å­¦ç”Ÿãƒ‡ãƒ¼ã‚¿å–å¾—
    async function loadStudentData() {
      const { data, error } = await supabase
        .from('students')
        .select('*')
        .eq('id', currentUser.id)
        .single();

      if (error && error.code !== 'PGRST116') {
        console.error('å­¦ç”Ÿãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return;
      }

      if (data) {
        currentStudent = data;
        displayCurrentPreference();
      }
    }

    // ç ”ç©¶å®¤ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¿½åŠ 
    function populateLabSelect() {
      const select = document.getElementById('lab-select') as HTMLSelectElement;
      select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

      let currentMajor = '';
      allLabs.forEach(lab => {
        if (lab.major !== currentMajor) {
          const optgroup = document.createElement('optgroup');
          optgroup.label = lab.major;
          select.appendChild(optgroup);
          currentMajor = lab.major;
        }
        
        const option = document.createElement('option');
        option.value = lab.id;
        option.textContent = `${lab.name} (${lab.professor || 'æœªå®š'}) - å®šå“¡${lab.capacity}å`;
        select.lastElementChild!.appendChild(option);
      });
    }

    // ç¾åœ¨ã®ç™»éŒ²æƒ…å ±ã‚’è¡¨ç¤º
    function displayCurrentPreference() {
      if (!currentStudent) return;

      const gpaInput = document.getElementById('gpa') as HTMLInputElement;
      const labSelect = document.getElementById('lab-select') as HTMLSelectElement;
      
      gpaInput.value = currentStudent.gpa.toString();
      labSelect.value = currentStudent.lab_id || '';

      const lab = allLabs.find(l => l.id === currentStudent!.lab_id);
      document.getElementById('current-gpa')!.textContent = currentStudent.gpa.toFixed(2);
      document.getElementById('current-lab')!.textContent = lab ? `${lab.name} (${lab.major})` : 'æœªç™»éŒ²';
      document.getElementById('current-preference')!.style.display = 'block';
    }

    // ç ”ç©¶å®¤ä¸€è¦§ã‚’è¡¨ç¤º
    async function displayLabs(filterMajor = '') {
      const container = document.getElementById('labs-list')!;
      const filteredLabs = filterMajor 
        ? allLabs.filter(lab => lab.major === filterMajor)
        : allLabs;

      if (filteredLabs.length === 0) {
        container.innerHTML = '<p class="no-data">è©²å½“ã™ã‚‹ç ”ç©¶å®¤ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      const { data: applicants } = await supabase
        .from('view_lab_applicants')
        .select('*');

      const labsHTML = filteredLabs.map(lab => {
        const labApplicants = applicants?.filter(a => a.lab_id === lab.id) || [];
        const applicantCount = labApplicants.length;
        const ratio = applicantCount / lab.capacity;
        const myRank = labApplicants.find(a => a.id === currentUser.id)?.rank;

        let statusClass = 'status-low';
        if (ratio >= 1.5) statusClass = 'status-high';
        else if (ratio >= 1) statusClass = 'status-medium';

        return `
          <div class="lab-card ${myRank ? 'my-lab' : ''}">
            <div class="lab-header">
              <h3>${lab.name}</h3>
              <span class="major-badge">${lab.major}</span>
            </div>
            <p class="professor">ğŸ‘¨â€ğŸ”¬ ${lab.professor || 'æœªå®š'}</p>
            <div class="lab-stats">
              <div class="stat">
                <span class="stat-label">å®šå“¡</span>
                <span class="stat-value">${lab.capacity}å</span>
              </div>
              <div class="stat">
                <span class="stat-label">å¸Œæœ›è€…æ•°</span>
                <span class="stat-value ${statusClass}">${applicantCount}å</span>
              </div>
              <div class="stat">
                <span class="stat-label">å€ç‡</span>
                <span class="stat-value ${statusClass}">${ratio.toFixed(2)}å€</span>
              </div>
            </div>
            ${myRank ? `<div class="my-rank">ã‚ãªãŸã®é †ä½: ${myRank}ä½ / ${applicantCount}å</div>` : ''}
            <button class="btn-detail" data-lab-id="${lab.id}">è©³ç´°ã‚’è¦‹ã‚‹</button>
          </div>
        `;
      }).join('');

      container.innerHTML = labsHTML;

      // è©³ç´°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      container.querySelectorAll('.btn-detail').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const labId = (e.target as HTMLElement).dataset.labId;
          window.location.href = `/lab/${labId}`;
        });
      });
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById('preference-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const gpa = parseFloat((document.getElementById('gpa') as HTMLInputElement).value);
      const labId = (document.getElementById('lab-select') as HTMLSelectElement).value;

      if (!labId) {
        alert('ç ”ç©¶å®¤ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const studentData = {
        id: currentUser.id,
        email: currentUser.email,
        gpa,
        lab_id: labId
      };

      const { error } = currentStudent
        ? await supabase.from('students').update(studentData).eq('id', currentUser.id)
        : await supabase.from('students').insert(studentData);

      if (error) {
        alert('ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ' + error.message);
        return;
      }

      alert('ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
      await loadStudentData();
      await displayLabs((document.getElementById('major-filter') as HTMLSelectElement).value);
    });

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    document.getElementById('logout-btn')?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/';
    });

    // ä¸»å°‚æ”»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    document.getElementById('major-filter')?.addEventListener('change', (e) => {
      displayLabs((e.target as HTMLSelectElement).value);
    });

    init();
  </script>
</Layout>

<style>
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  header {
    background: white;
    padding: 1.5rem;
    border-radius: 0;
    border: 1px solid #e0e0e0;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  header h1 {
    margin: 0;
    font-size: 1.8rem;
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .btn-logout, .btn-admin {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 0;
    cursor: pointer;
  }

  .btn-logout {
    background: #f44336;
    color: white;
  }

  .btn-logout:hover {
    background: #d32f2f;
  }

  .loading {
    text-align: center;
    padding: 3rem;
    color: white;
    font-size: 1.2rem;
  }

  .card {
    background: white;
    padding: 2rem;
    border-radius: 0;
    border: 1px solid #e0e0e0;
    margin-bottom: 2rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .card h2 {
    margin-bottom: 1.5rem;
    color: #1a1a1a;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
  }

  .required {
    color: #f44336;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 0;
    font-size: 1rem;
  }

  .form-group small {
    display: block;
    margin-top: 0.25rem;
    color: #666;
    font-size: 0.85rem;
  }

  .btn-primary {
    padding: 0.75rem 2rem;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 0;
    cursor: pointer;
    font-size: 1rem;
  }

  .btn-primary:hover {
    background: #45a049;
  }

  .current-info {
    margin-top: 2rem;
    padding: 1rem;
    background: #f5f5f5;
    border-radius: 0;
    border: 1px solid #e0e0e0;
  }

  .current-info h3 {
    margin-bottom: 0.5rem;
    font-size: 1rem;
  }

  .current-info p {
    margin: 0.25rem 0;
  }

  .filter-group {
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .filter-group select {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 0;
  }

  .labs-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  .lab-card {
    border: 1px solid #ddd;
    border-radius: 0;
    padding: 1.5rem;
    transition: transform 0.2s, box-shadow 0.2s;
    background: white;
  }

  .lab-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .lab-card.my-lab {
    border: 2px solid #4CAF50;
    background: #f1f8f4;
  }

  .lab-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.5rem;
  }

  .lab-header h3 {
    margin: 0;
    font-size: 1.1rem;
  }

  .major-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    background: #e3f2fd;
    color: #1976d2;
    border-radius: 0;
    border: 1px solid #90caf9;
  }

  .professor {
    color: #666;
    margin: 0.5rem 0 1rem;
    font-size: 0.9rem;
  }

  .lab-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin: 1rem 0;
  }

  .stat {
    text-align: center;
  }

  .stat-label {
    display: block;
    font-size: 0.75rem;
    color: #666;
    margin-bottom: 0.25rem;
  }

  .stat-value {
    display: block;
    font-size: 1.1rem;
    font-weight: 600;
  }

  .status-low { color: #4CAF50; }
  .status-medium { color: #FF9800; }
  .status-high { color: #f44336; }

  .my-rank {
    background: #4CAF50;
    color: white;
    padding: 0.5rem;
    border-radius: 0;
    text-align: center;
    margin: 1rem 0;
    font-weight: 600;
  }

  .btn-detail {
    width: 100%;
    padding: 0.5rem;
    background: #2196F3;
    color: white;
    border: none;
    border-radius: 0;
    cursor: pointer;
  }

  .btn-detail:hover {
    background: #1976D2;
  }

  .no-data {
    text-align: center;
    color: #666;
    padding: 2rem;
  }

  @media (max-width: 768px) {
    header {
      flex-direction: column;
      gap: 1rem;
      text-align: center;
    }

    .labs-list {
      grid-template-columns: 1fr;
    }
  }
</style>
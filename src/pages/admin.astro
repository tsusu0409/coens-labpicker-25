---
import Layout from '../layouts/Layout.astro';

export const prerender = false;
---

<Layout title="coens-labpicker-25 - ç®¡ç†è€…ãƒšãƒ¼ã‚¸">
  <div class="container">
    <div id="loading" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>

    <div id="content" style="display: none;">
      <header>
        <div>
          <h1>ğŸ”§ ç®¡ç†è€…ãƒšãƒ¼ã‚¸</h1>
          <p class="admin-email" id="admin-email"></p>
        </div>
        <div class="header-buttons">
          <button id="dashboard-btn" class="btn-secondary">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸</button>
          <button id="logout-btn" class="btn-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </header>

      <!-- çµ±è¨ˆæƒ…å ± -->
      <section class="card stats-card">
        <h2>ğŸ“Š çµ±è¨ˆæƒ…å ±</h2>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-icon">ğŸ«</div>
            <div class="stat-value" id="total-labs">0</div>
            <div class="stat-label">ç ”ç©¶å®¤æ•°</div>
          </div>
          <div class="stat-box">
            <div class="stat-icon">ğŸ‘¨â€ğŸ“</div>
            <div class="stat-value" id="total-students">0</div>
            <div class="stat-label">ç™»éŒ²å­¦ç”Ÿæ•°</div>
          </div>
          <div class="stat-box">
            <div class="stat-icon">ğŸ“ˆ</div>
            <div class="stat-value" id="avg-gpa">0.00</div>
            <div class="stat-label">å¹³å‡GPA</div>
          </div>
          <div class="stat-box">
            <div class="stat-icon">ğŸ¯</div>
            <div class="stat-value" id="registration-rate">0%</div>
            <div class="stat-label">ç™»éŒ²ç‡</div>
          </div>
        </div>
      </section>

      <!-- ç ”ç©¶å®¤ç®¡ç† -->
      <section class="card">
        <div class="section-header">
          <h2>ğŸ« ç ”ç©¶å®¤ç®¡ç†</h2>
          <button id="add-lab-btn" class="btn-primary">+ æ–°è¦è¿½åŠ </button>
        </div>

        <!-- ç ”ç©¶å®¤è¿½åŠ /ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div id="lab-form" class="form-container" style="display: none;">
          <h3 id="form-title">ç ”ç©¶å®¤ã‚’è¿½åŠ </h3>
          <form id="lab-form-element">
            <input type="hidden" id="lab-id" />
            
            <div class="form-group">
              <label for="lab-name">ç ”ç©¶å®¤å <span class="required">*</span></label>
              <input type="text" id="lab-name" required placeholder="ä¾‹: é‡å­ç‰©æ€§ç ”ç©¶å®¤" />
            </div>

            <div class="form-group">
              <label for="lab-professor">æ•™å“¡å</label>
              <input type="text" id="lab-professor" placeholder="ä¾‹: å±±ç”°å¤ªéƒ" />
            </div>

            <div class="form-group">
              <label for="lab-major">ä¸»å°‚æ”» <span class="required">*</span></label>
              <select id="lab-major" required>
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="å¿œç”¨ç‰©ç†ä¸»å°‚æ”»">å¿œç”¨ç‰©ç†ä¸»å°‚æ”»</option>
                <option value="é›»å­ãƒ»é‡å­å·¥å­¦ä¸»å°‚æ”»">é›»å­ãƒ»é‡å­å·¥å­¦ä¸»å°‚æ”»</option>
                <option value="ç‰©æ€§å·¥å­¦ä¸»å°‚æ”»">ç‰©æ€§å·¥å­¦ä¸»å°‚æ”»</option>
                <option value="ç‰©è³ªãƒ»åˆ†å­å·¥å­¦ä¸»å°‚æ”»">ç‰©è³ªãƒ»åˆ†å­å·¥å­¦ä¸»å°‚æ”»</option>
              </select>
            </div>

            <div class="form-group">
              <label for="lab-capacity">å®šå“¡ <span class="required">*</span></label>
              <input type="number" id="lab-capacity" required min="1" placeholder="ä¾‹: 8" />
            </div>

            <div class="form-actions">
              <button type="submit" class="btn-primary">ä¿å­˜</button>
              <button type="button" id="cancel-btn" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
          </form>
        </div>

        <!-- ç ”ç©¶å®¤ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ç ”ç©¶å®¤å</th>
                <th>æ•™å“¡</th>
                <th>ä¸»å°‚æ”»</th>
                <th>å®šå“¡</th>
                <th>å¸Œæœ›è€…æ•°</th>
                <th>å€ç‡</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="labs-table-body">
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <div id="unauthorized" style="display: none;">
      <div class="error-container">
        <h1>âš ï¸ ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“</h1>
        <p>ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™</p>
        <button onclick="window.location.href='/dashboard'" class="btn-primary">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
    import { supabase, type Lab, type Major } from '../lib/supabase';

    let currentUser: any = null;
    let isAdmin = false;
    let allLabs: Lab[] = [];
    let editingLabId: string | null = null;

    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session) {
        window.location.href = '/';
        return;
      }

      currentUser = session.user;

      if (!currentUser.email?.endsWith('@u.tsukuba.ac.jp')) {
        alert('ç­‘æ³¢å¤§å­¦ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™');
        await supabase.auth.signOut();
        window.location.href = '/';
        return;
      }

      // ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯
      const { data: adminData } = await supabase
        .from('admins')
        .select('*')
        .eq('user_id', currentUser.id)
        .single();

      if (!adminData) {
        document.getElementById('loading')!.style.display = 'none';
        document.getElementById('unauthorized')!.style.display = 'block';
        return;
      }

      isAdmin = true;
      document.getElementById('admin-email')!.textContent = currentUser.email;

      await Promise.all([
        loadStats(),
        loadLabs()
      ]);

      document.getElementById('loading')!.style.display = 'none';
      document.getElementById('content')!.style.display = 'block';
    }

    async function loadStats() {
      // ç ”ç©¶å®¤æ•°
      const { count: labCount } = await supabase
        .from('labs')
        .select('*', { count: 'exact', head: true });

      // å­¦ç”Ÿæ•°ã¨GPA
      const { data: students } = await supabase
        .from('students')
        .select('gpa');

      const studentCount = students?.length || 0;
      const avgGpa = studentCount > 0
        ? students!.reduce((sum, s) => sum + s.gpa, 0) / studentCount
        : 0;

      // å®šå“¡ç·æ•°
      const { data: labs } = await supabase
        .from('labs')
        .select('capacity');
      
      const totalCapacity = labs?.reduce((sum, l) => sum + l.capacity, 0) || 0;
      const registrationRate = totalCapacity > 0 
        ? (studentCount / totalCapacity * 100).toFixed(0)
        : 0;

      document.getElementById('total-labs')!.textContent = labCount?.toString() || '0';
      document.getElementById('total-students')!.textContent = studentCount.toString();
      document.getElementById('avg-gpa')!.textContent = avgGpa.toFixed(2);
      document.getElementById('registration-rate')!.textContent = registrationRate + '%';
    }

    async function loadLabs() {
      const { data: labs, error } = await supabase
        .from('labs')
        .select('*')
        .order('major')
        .order('name');

      if (error) {
        console.error('ç ”ç©¶å®¤å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return;
      }

      allLabs = labs || [];

      // å„ç ”ç©¶å®¤ã®å¸Œæœ›è€…æ•°ã‚’å–å¾—
      const { data: applicants } = await supabase
        .from('view_lab_applicants')
        .select('lab_id');

      const applicantCounts = applicants?.reduce((acc, a) => {
        acc[a.lab_id] = (acc[a.lab_id] || 0) + 1;
        return acc;
      }, {} as Record<string, number>) || {};

      displayLabs(applicantCounts);
    }

    function displayLabs(applicantCounts: Record<string, number>) {
      const tbody = document.getElementById('labs-table-body')!;
      
      tbody.innerHTML = allLabs.map(lab => {
        const count = applicantCounts[lab.id] || 0;
        const ratio = lab.capacity > 0 ? (count / lab.capacity).toFixed(2) : '0.00';
        
        let ratioClass = 'ratio-low';
        if (parseFloat(ratio) >= 1.5) ratioClass = 'ratio-high';
        else if (parseFloat(ratio) >= 1) ratioClass = 'ratio-medium';

        return `
          <tr>
            <td><strong>${lab.name}</strong></td>
            <td>${lab.professor || '-'}</td>
            <td><span class="major-badge">${lab.major}</span></td>
            <td>${lab.capacity}å</td>
            <td>${count}å</td>
            <td class="${ratioClass}">${ratio}å€</td>
            <td>
              <button class="btn-edit" data-id="${lab.id}">ç·¨é›†</button>
              <button class="btn-delete" data-id="${lab.id}">å‰Šé™¤</button>
            </td>
          </tr>
        `;
      }).join('');

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
      tbody.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const labId = (e.target as HTMLElement).dataset.id!;
          editLab(labId);
        });
      });

      tbody.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const labId = (e.target as HTMLElement).dataset.id!;
          deleteLab(labId);
        });
      });
    }

    function showForm(title: string) {
      document.getElementById('form-title')!.textContent = title;
      document.getElementById('lab-form')!.style.display = 'block';
    }

    function hideForm() {
      document.getElementById('lab-form')!.style.display = 'none';
      (document.getElementById('lab-form-element') as HTMLFormElement).reset();
      editingLabId = null;
    }

    function editLab(labId: string) {
      const lab = allLabs.find(l => l.id === labId);
      if (!lab) return;

      editingLabId = labId;
      (document.getElementById('lab-id') as HTMLInputElement).value = labId;
      (document.getElementById('lab-name') as HTMLInputElement).value = lab.name;
      (document.getElementById('lab-professor') as HTMLInputElement).value = lab.professor || '';
      (document.getElementById('lab-major') as HTMLSelectElement).value = lab.major;
      (document.getElementById('lab-capacity') as HTMLInputElement).value = lab.capacity.toString();

      showForm('ç ”ç©¶å®¤ã‚’ç·¨é›†');
    }

    async function deleteLab(labId: string) {
      const lab = allLabs.find(l => l.id === labId);
      if (!lab) return;

      if (!confirm(`ã€Œ${lab.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€» ã“ã®ç ”ç©¶å®¤ã‚’å¸Œæœ›ã—ã¦ã„ã‚‹å­¦ç”Ÿã®ãƒ‡ãƒ¼ã‚¿ã‚‚ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚`)) {
        return;
      }

      const { error } = await supabase
        .from('labs')
        .delete()
        .eq('id', labId);

      if (error) {
        alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message);
        return;
      }

      alert('å‰Šé™¤ã—ã¾ã—ãŸ');
      await Promise.all([loadStats(), loadLabs()]);
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById('lab-form-element')?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const labData = {
        name: (document.getElementById('lab-name') as HTMLInputElement).value,
        professor: (document.getElementById('lab-professor') as HTMLInputElement).value || null,
        major: (document.getElementById('lab-major') as HTMLSelectElement).value as Major,
        capacity: parseInt((document.getElementById('lab-capacity') as HTMLInputElement).value)
      };

      let error;
      if (editingLabId) {
        ({ error } = await supabase
          .from('labs')
          .update(labData)
          .eq('id', editingLabId));
      } else {
        ({ error } = await supabase
          .from('labs')
          .insert(labData));
      }

      if (error) {
        alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);
        return;
      }

      alert(editingLabId ? 'æ›´æ–°ã—ã¾ã—ãŸ' : 'è¿½åŠ ã—ã¾ã—ãŸ');
      hideForm();
      await Promise.all([loadStats(), loadLabs()]);
    });

    // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('add-lab-btn')?.addEventListener('click', () => {
      showForm('ç ”ç©¶å®¤ã‚’è¿½åŠ ');
    });

    document.getElementById('cancel-btn')?.addEventListener('click', hideForm);

    document.getElementById('dashboard-btn')?.addEventListener('click', () => {
      window.location.href = '/dashboard';
    });

    document.getElementById('logout-btn')?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/';
    });

    init();
  </script>
</Layout>

<style>
  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
    background: #fafafa;
    min-height: 100vh;
  }

  .loading {
    text-align: center;
    padding: 3rem;
    color: #666;
    font-size: 1.2rem;
  }

  header {
    background: white;
    padding: 1.5rem;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #e0e0e0;
  }

  header h1 {
    margin: 0 0 0.25rem 0;
    font-size: 1.8rem;
  }

  .admin-email {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
  }

  .header-buttons {
    display: flex;
    gap: 1rem;
  }

  .btn-primary, .btn-secondary, .btn-logout {
    padding: 0.75rem 1.5rem;
    border: none;
    cursor: pointer;
    font-size: 1rem;
  }

  .btn-primary {
    background: #4CAF50;
    color: white;
  }

  .btn-primary:hover {
    background: #45a049;
  }

  .btn-secondary {
    background: #f0f0f0;
    color: #333;
    border: 1px solid #ddd;
  }

  .btn-secondary:hover {
    background: #e0e0e0;
  }

  .btn-logout {
    background: #f44336;
    color: white;
  }

  .btn-logout:hover {
    background: #d32f2f;
  }

  .card {
    background: white;
    padding: 2rem;
    margin-bottom: 2rem;
    border: 1px solid #e0e0e0;
  }

  .stats-card {
    background: #1976d2;
    color: white;
    border: none;
  }

  .stats-card h2 {
    color: white;
    margin-bottom: 1.5rem;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
  }

  .stat-box {
    background: rgba(255,255,255,0.2);
    padding: 1.5rem;
    text-align: center;
    border: 1px solid rgba(255,255,255,0.3);
  }

  .stat-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .section-header h2 {
    margin: 0;
  }

  .form-container {
    background: #f5f5f5;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border: 1px solid #e0e0e0;
  }

  .form-container h3 {
    margin: 0 0 1.5rem 0;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
  }

  .required {
    color: #f44336;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    font-size: 1rem;
  }

  .form-actions {
    display: flex;
    gap: 1rem;
  }

  .table-container {
    overflow-x: auto;
    border: 1px solid #e0e0e0;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th, td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
  }

  th {
    background: #f5f5f5;
    font-weight: 600;
  }

  .major-badge {
    display: inline-block;
    font-size: 0.85rem;
    padding: 0.25rem 0.75rem;
    background: #e3f2fd;
    color: #1976d2;
    border: 1px solid #90caf9;
  }

  .ratio-low { color: #4CAF50; font-weight: 600; }
  .ratio-medium { color: #FF9800; font-weight: 600; }
  .ratio-high { color: #f44336; font-weight: 600; }

  .btn-edit, .btn-delete {
    padding: 0.5rem 1rem;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    margin-right: 0.5rem;
  }

  .btn-edit {
    background: #2196F3;
    color: white;
  }

  .btn-edit:hover {
    background: #1976D2;
  }

  .btn-delete {
    background: #f44336;
    color: white;
  }

  .btn-delete:hover {
    background: #d32f2f;
  }

  .error-container {
    background: white;
    padding: 3rem;
    text-align: center;
    border: 1px solid #e0e0e0;
  }

  .error-container h1 {
    margin-bottom: 1rem;
    color: #f44336;
  }

  .error-container p {
    margin-bottom: 2rem;
    color: #666;
  }

  @media (max-width: 768px) {
    header {
      flex-direction: column;
      gap: 1rem;
      text-align: center;
    }

    .header-buttons {
      flex-direction: column;
      width: 100%;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }

    .section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .form-actions {
      flex-direction: column;
    }

    table {
      font-size: 0.85rem;
    }

    th, td {
      padding: 0.5rem;
    }
  }
</style>